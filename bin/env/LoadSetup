#!/bin/bash
# shortcut to source setup scripts stored in
# ${HOME}/bin/ExtraSetups, ${HOME}/bin/Setups or ${HOME}/bin/${KEY}/setup

function LoadSetup_DetectROOTscriptDir() {
	local Dir="$(dirname -- "${BASH_SOURCE:-${HOME}/bin/Setups}")"
	[[ "${Dir:0:2}" == "./" ]] && Dir="$(pwd)/${Dir}"
	while [[ ! -d "${Dir}/Setups" ]]; do
		Dir="$(dirname "$Dir")"
		[[ "$Dir" == "/" ]] && return 3
	done
	echo "$Dir"
	return 0
} # LoadSetup_DetectROOTscriptDir()


ROOT_SCRIPTS_DIR="$(LoadSetup_DetectROOTscriptDir)"
if [[ ! -d "${ROOT_SCRIPTS_DIR}/Setups" ]]; then
	ERROR "${BASH_SOURCE}: Base script directory not found!"
fi
unset -f LoadSetup_DetectROOTscriptDir

function Setup() {
	local Package="$1"
	local Indent="$2" # cosmetic
	local -i Quiet="${3:-0}"

	local SetupScript
	for SetupScript in \
	  "${ROOT_SCRIPTS_DIR}/ExtraSetups/${Package}" \
	  "${ROOT_SCRIPTS_DIR}/Setups/${Package}" \
	  "${ROOT_SCRIPTS_DIR}/${Package}/setup"
	do
		[[ -r "$SetupScript" ]] || continue
		local TargetSetupScript="$SetupScript"
		local SetupDir="$(dirname "$TargetSetupScript")"
		local SetupScriptName="$(basename "$TargetSetupScript")"
		[[ $Quiet -le 0 ]] && echo "${Indent}Setup (${SetupScriptName}) from '${SetupDir}'"
		local CWD="$(pwd)"
		cd "$SetupDir"
		shift
		local ReturnCode
		if [[ $Quiet -le 1 ]]; then
			source "./${SetupScriptName}" "$@"
		else
			source "./${SetupScriptName}" "$@" > /dev/null
		fi
		ReturnCode=$?
		[[ "$(pwd)" == "$SetupDir" ]] && cd "$CWD"
		return $ReturnCode
	done
	# fallback on an existing setup (e.g. UPS)
	[[ $Quiet -le 0 ]] && echo "${Indent}setup $@"
	if [[ $Quiet -le 1 ]]; then
		setup "$@"
	else
		setup "$@" > /dev/null
	fi
} # Setup()


function _BashCompletion_Setup() {
	# auto-completion of the thing being set up;
	# choice among the candidates in the blessed directories
	
	# Pointer to current completion word.
	# By convention, it's named "cur" but this isn't strictly necessary.
	local cur="${COMP_WORDS[COMP_CWORD]}"
	
	COMPREPLY=()   # Array variable storing the possible completions.
	
	local SetupScript
	for SetupScript in \
	  "${ROOT_SCRIPTS_DIR}/ExtraSetups/"* \
	  "${ROOT_SCRIPTS_DIR}/Setups/"* \
	  "${ROOT_SCRIPTS_DIR}/"*
	do
		local Candidate
		if [[ -f "$SetupScript" ]]; then
			Candidate="$(basename "$SetupScript")"
		elif [[ -f "${SetupScript}/setup" ]]; then
			Candidate="$(basename "$(dirname "$SetupScript")")"
		else
			continue
		fi
		[[ "${Candidate#${cur}}" == "$Candidate" ]] && continue
		COMPREPLY=( "${COMPREPLY[@]}" "$Candidate" )
	done
	
	return 0
} # _BashCompletion_Setup()

complete -F _BashCompletion_Setup Setup
